---
layout: default
title: Profile
permalink: /profile/
---

<div class="hub-layout" style="max-width:800px; margin:0 auto;">
    <div id="profile-loading" style="text-align:center; padding:80px;">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--text-muted);"></i>
    </div>

    <div id="profile-content" style="display:none; animation: fadeUp 0.3s forwards;">
        <div class="profile-header">
            <img id="p-avatar" class="profile-avatar-xl" src="">
            <div class="profile-info">
                <h1 id="p-name">User</h1>
                <p id="p-email" style="color:var(--text-muted); margin-bottom:10px;">email@example.com</p>
                <span id="p-status-badge" class="badge" style="background:#238636; color:white; border:none; padding:4px 10px; font-size:0.85rem;">
                    User
                </span>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="profile-tab active" onclick="switchTab('settings')">
                <i class="fa-solid fa-sliders"></i> {% lang en %}Settings{% endlang %}{% lang ru %}Настройки{% endlang %}
            </button>
            <button class="profile-tab" onclick="switchTab('security')">
                <i class="fa-solid fa-shield-halved"></i> {% lang en %}Security{% endlang %}{% lang ru %}Безопасность{% endlang %}
            </button>
            <button id="btn-tab-admin" class="profile-tab" onclick="switchTab('admin')" style="display:none; color:#d73a49;">
                <i class="fa-solid fa-terminal"></i> Admin
            </button>
        </div>

        <div id="tab-settings" class="settings-section active">
            <div class="settings-card">
                <h3>{% lang en %}Preferences{% endlang %}{% lang ru %}Предпочтения{% endlang %}</h3>
                
                <div class="settings-row">
                    <div>
                        <div style="font-weight:600;">{% lang en %}Interface Language{% endlang %}{% lang ru %}Язык интерфейса{% endlang %}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">{% lang en %}Changes text across the site{% endlang %}{% lang ru %}Изменяет язык сайта{% endlang %}</div>
                    </div>
                    <select id="pref-lang" class="form-select" style="width:140px;">
                        <option value="en">English</option>
                        <option value="ru">Русский</option>
                    </select>
                </div>

                <div class="settings-row">
                    <div>
                        <div style="font-weight:600;">{% lang en %}Email Newsletter{% endlang %}{% lang ru %}Рассылка новостей{% endlang %}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">{% lang en %}Get updates about new mods{% endlang %}{% lang ru %}Получать новости о новых модах{% endlang %}</div>
                    </div>
                    <input id="pref-email-notif" type="checkbox" style="width:20px; height:20px; accent-color: var(--accent);">
                </div>

                <div style="margin-top:20px; text-align:right;">
                    <button id="save-settings-btn" onclick="saveProfile()" class="btn primary" style="min-width:120px;">
                        {% lang en %}Save Changes{% endlang %}{% lang ru %}Сохранить{% endlang %}
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-security" class="settings-section">
            <div class="settings-card">
                <h3>{% lang en %}Session Management{% endlang %}{% lang ru %}Управление сессией{% endlang %}</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">
                    {% lang en %}Log out of your account on this device.{% endlang %}
                    {% lang ru %}Выход из аккаунта на этом устройстве.{% endlang %}
                </p>
                <button onclick="supabase.auth.signOut().then(() => window.location.href = '/')" class="btn" style="border-color:#d73a49; color:#d73a49;">
                    <i class="fa-solid fa-right-from-bracket"></i> {% lang en %}Log Out{% endlang %}{% lang ru %}Выйти{% endlang %}
                </button>
            </div>
        </div>

        <div id="tab-admin" class="settings-section">
            <div class="settings-card" style="border-color:#d73a49;">
                <h3 style="color:#d73a49; display:flex; align-items:center; gap:10px;">
                    <i class="fa-solid fa-user-secret"></i> Admin Console
                </h3>
                <div style="background:var(--bg-body); padding:15px; border-radius:6px; margin-top:15px; font-family:monospace; font-size:0.9rem;">
                    <div>User ID: <span id="adm-uid" style="color:var(--accent);">...</span></div>
                    <div>Email: <span id="adm-email" style="color:#58a6ff;">...</span></div>
                    <div>Role: Superuser</div>
                </div>
            </div>
        </div>

    </div>
    
    <div id="guest-view" style="display:none; text-align:center; padding:80px 20px;">
        <div style="background:var(--bg-panel); padding:40px; border-radius:12px; border:1px solid var(--border); display:inline-block; max-width:400px;">
            <i class="fa-solid fa-user-astronaut" style="font-size:3rem; color:var(--text-muted); margin-bottom:20px;"></i>
            <h2>{% lang en %}Authentication Required{% endlang %}{% lang ru %}Вход в систему{% endlang %}</h2>
            <p style="margin-bottom:25px; color:var(--text-muted);">
                {% lang en %}Please log in to view your profile and manage settings.{% endlang %}
                {% lang ru %}Пожалуйста, войдите, чтобы управлять профилем.{% endlang %}
            </p>
            <button onclick="openAuthModal()" class="btn primary" style="width:100%;">
                {% lang en %}Log In{% endlang %}{% lang ru %}Войти{% endlang %}
            </button>
        </div>
    </div>
</div>

<script>
    // Объявляем глобально, чтобы main.js мог вызвать
    window.renderProfilePage = async function(user, isAdmin) {
        const loading = document.getElementById('profile-loading');
        const content = document.getElementById('profile-content');
        const guest = document.getElementById('guest-view');
        
        if(!content) return;
        if(loading) loading.style.display = 'none';
        
        if(user) {
            content.style.display = 'block';
            if(guest) guest.style.display = 'none';
            
            document.getElementById('p-avatar').src = user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';
            document.getElementById('p-name').textContent = user.user_metadata.full_name || 'User';
            document.getElementById('p-email').textContent = user.email;

            if (isAdmin) {
                const badge = document.getElementById('p-status-badge');
                badge.style.backgroundColor = '#d73a49';
                badge.innerHTML = '<i class="fa-solid fa-shield-halved"></i> Administrator';
                const adminTab = document.getElementById('btn-tab-admin');
                if(adminTab) adminTab.style.display = 'inline-flex'; // Fix display
                
                // Fill admin info
                document.getElementById('adm-uid').textContent = user.id;
                document.getElementById('adm-email').textContent = user.email;
            }

            await loadUserSettings(user.id);
        } else {
            content.style.display = 'none';
            if(guest) guest.style.display = 'block';
        }
    };

    async function loadUserSettings(userId) {
        if(!window.supabase) return;
        const { data } = await window.supabase.from('profiles').select('*').eq('id', userId).single();
        if (data) {
            const langSelect = document.getElementById('pref-lang');
            const notifCheck = document.getElementById('pref-email-notif');
            if(langSelect && data.language) langSelect.value = data.language;
            if(notifCheck && data.email_notif !== undefined) notifCheck.checked = data.email_notif;
        }
    }

    window.saveProfile = async () => {
        if(!window.currentUser) return;
        const btn = document.getElementById('save-settings-btn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        const lang = document.getElementById('pref-lang').value;
        const notif = document.getElementById('pref-email-notif').checked;

        const { error } = await window.supabase.from('profiles').upsert({ 
            id: window.currentUser.id, 
            language: lang, 
            email_notif: notif,
            updated_at: new Date()
        });

        if (!error) {
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
            btn.style.color = '#238636';
            if ((lang === 'ru' && !window.location.pathname.startsWith('/ru')) || (lang === 'en' && window.location.pathname.startsWith('/ru'))) {
                setTimeout(() => window.location.href = lang === 'ru' ? '/ru/profile/' : '/profile/', 1000);
            }
        } else {
            btn.innerHTML = 'Error';
            console.error(error);
        }
        setTimeout(() => { btn.innerHTML = 'Save Changes'; btn.disabled = false; btn.style.color = ''; }, 2000);
    };

    window.switchTab = function(tabName) {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        event.currentTarget.classList.add('active'); // Use currentTarget for button w/ icon
        document.getElementById('tab-' + tabName).classList.add('active');
    };
</script>
