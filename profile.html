---
layout: default
title: Profile
permalink: /profile/
---

<div class="hub-layout" style="max-width:800px; margin:0 auto;">
    <div id="profile-loading" style="text-align:center; padding:80px;">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--text-muted);"></i>
    </div>

    <div id="profile-content" style="display:none; animation: fadeUp 0.3s forwards;">
        <div class="profile-header">
            <img id="p-avatar" class="profile-avatar-xl" src="">
            <div class="profile-info">
                <h1 id="p-name">User</h1>
                <p id="p-email" style="color:var(--text-muted); margin-bottom:10px;">email@example.com</p>
                <span id="p-status-badge" class="badge" style="background:#238636; color:white; border:none; padding:4px 10px; font-size:0.85rem;">
                    User
                </span>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="profile-tab active" onclick="switchTab('settings')">
                <i class="fa-solid fa-sliders"></i> {% lang en %}Settings{% endlang %}{% lang ru %}Настройки{% endlang %}
            </button>
            <button class="profile-tab" onclick="switchTab('security')">
                <i class="fa-solid fa-shield-halved"></i> {% lang en %}Security{% endlang %}{% lang ru %}Безопасность{% endlang %}
            </button>
            <button id="btn-tab-admin" class="profile-tab" onclick="switchTab('admin')" style="display:none; color:#d73a49;">
                <i class="fa-solid fa-terminal"></i> Admin
            </button>
        </div>

        <div id="tab-settings" class="settings-section active">
            <div class="settings-card">
                <h3>{% lang en %}Preferences{% endlang %}{% lang ru %}Предпочтения{% endlang %}</h3>
                
                <div class="settings-row">
                    <div>
                        <div style="font-weight:600;">{% lang en %}Interface Language{% endlang %}{% lang ru %}Язык интерфейса{% endlang %}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Changes text across the site</div>
                    </div>
                    <select id="pref-lang" class="form-select" style="width:140px;">
                        <option value="en">English</option>
                        <option value="ru">Русский</option>
                    </select>
                </div>

                <div class="settings-row">
                    <div>
                        <div style="font-weight:600;">{% lang en %}Email Newsletter{% endlang %}{% lang ru %}Рассылка новостей{% endlang %}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Get updates about new mods</div>
                    </div>
                    <input id="pref-email-notif" type="checkbox" style="width:20px; height:20px; accent-color: var(--accent);">
                </div>

                <div class="settings-row">
                    <div>
                        <div style="font-weight:600;">{% lang en %}Developer Mode{% endlang %}{% lang ru %}Режим разработчика{% endlang %}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Enable advanced tool features</div>
                    </div>
                    <input id="pref-dev-mode" type="checkbox" style="width:20px; height:20px; accent-color: var(--accent);">
                </div>

                <div style="margin-top:20px; text-align:right;">
                    <button id="save-settings-btn" onclick="saveProfile()" class="btn primary" style="min-width:120px;">
                        {% lang en %}Save Changes{% endlang %}{% lang ru %}Сохранить{% endlang %}
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-security" class="settings-section">
            <div class="settings-card">
                <h3>Session</h3>
                <button onclick="supabase.auth.signOut().then(() => window.location.href = '/')" class="btn" style="border-color:#d73a49; color:#d73a49;">
                    <i class="fa-solid fa-right-from-bracket"></i> Log Out
                </button>
            </div>
        </div>

        <div id="tab-admin" class="settings-section">
            <div class="settings-card" style="border-color:#d73a49;">
                <h3 style="color:#d73a49;"><i class="fa-solid fa-user-secret"></i> Admin Console</h3>
                
                <h4 style="margin-top:20px; margin-bottom:10px;">Banned Users</h4>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="ban-search" class="form-input" placeholder="Search by name..." onkeyup="filterBanList()">
                    <button onclick="loadBannedUsers()" class="btn"><i class="fa-solid fa-rotate"></i></button>
                </div>

                <div style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                        <thead style="background:var(--bg-body); color:var(--text-muted); text-align:left;">
                            <tr>
                                <th style="padding:10px;">User</th>
                                <th style="padding:10px;">Banned Since</th>
                                <th style="padding:10px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="ban-list-body">
                            <tr><td colspan="3" style="padding:20px; text-align:center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    
    <div id="guest-view" style="display:none; text-align:center; padding:80px 20px;">
        <i class="fa-solid fa-user-astronaut" style="font-size:3rem; color:var(--text-muted); margin-bottom:20px;"></i>
        <h2>Authentication Required</h2>
        <button onclick="openAuthModal()" class="btn primary">Log In</button>
    </div>
</div>

<script>
    // --- PROFILE LOGIC ---
    window.renderProfilePage = async function(user, isAdmin) {
        const loading = document.getElementById('profile-loading');
        const content = document.getElementById('profile-content');
        const guest = document.getElementById('guest-view');
        
        if(!content) return;
        if(loading) loading.style.display = 'none';
        
        if(user) {
            content.style.display = 'block';
            if(guest) guest.style.display = 'none';
            
            document.getElementById('p-avatar').src = user.user_metadata.avatar_url;
            document.getElementById('p-name').textContent = user.user_metadata.full_name || 'User';
            document.getElementById('p-email').textContent = user.email;

            if (isAdmin) {
                const badge = document.getElementById('p-status-badge');
                badge.style.backgroundColor = '#d73a49';
                badge.innerHTML = '<i class="fa-solid fa-shield-halved"></i> Administrator';
                document.getElementById('btn-tab-admin').style.display = 'inline-flex';
                loadBannedUsers(); 
            }

            // Загрузка настроек
            const { data } = await window.supabase.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                const ls = document.getElementById('pref-lang');
                const ns = document.getElementById('pref-email-notif');
                const dev = document.getElementById('pref-dev-mode');
                
                if(ls && data.language) ls.value = data.language;
                if(ns && data.email_notif !== undefined) ns.checked = data.email_notif;
                // Предполагаем, что dev_mode может быть в JSONB поле или отдельной колонке, 
                // если нет - просто сохраняем в локалсторадж для UI эффекта
                if(dev) dev.checked = localStorage.getItem('dev_mode') === 'true';
            }
        } else {
            content.style.display = 'none';
            if(guest) guest.style.display = 'block';
        }
    };

    window.saveProfile = async () => {
        const btn = document.getElementById('save-settings-btn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        const lang = document.getElementById('pref-lang').value;
        const notif = document.getElementById('pref-email-notif').checked;
        const devMode = document.getElementById('pref-dev-mode').checked;

        // Сохраняем dev_mode локально (или добавь колонку в БД)
        localStorage.setItem('dev_mode', devMode);

        const { error } = await window.supabase.from('profiles').upsert({ 
            id: window.currentUser.id, 
            language: lang, 
            email_notif: notif,
            updated_at: new Date()
        });

        if (!error) {
            btn.innerHTML = 'Saved!';
            const path = window.location.pathname;
            if ((lang === 'ru' && !path.startsWith('/ru')) || (lang === 'en' && path.startsWith('/ru'))) {
                setTimeout(() => window.location.href = lang === 'ru' ? '/ru/profile/' : '/profile/', 500);
            } else {
                setTimeout(() => { btn.innerHTML = 'Save Changes'; btn.disabled = false; }, 1000);
            }
        } else {
            btn.innerHTML = 'Error';
            console.error(error);
            alert(error.message); // Увидишь детальную ошибку если SQL не сработает
            btn.disabled = false;
        }
    };

    // --- ADMIN LOGIC ---
    let bannedUsersCache = [];

    window.loadBannedUsers = async () => {
        if (!window.fetchBannedUsers) return; // Функция может не быть в глобале, если admin.js не подгружен
        // Лучше использовать прямой запрос здесь, если admin.js глючит
        const tbody = document.getElementById('ban-list-body');
        tbody.innerHTML = '<tr><td colspan="3" style="padding:10px; text-align:center;">Loading...</td></tr>';
        
        const { data, error } = await window.supabase.from('profiles').select('*').eq('is_banned', true);
        
        if(data) {
            bannedUsersCache = data;
            renderBanList(data);
        } else {
            tbody.innerHTML = '<tr><td colspan="3">Error loading</td></tr>';
        }
    };

    function renderBanList(list) {
        const tbody = document.getElementById('ban-list-body');
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="padding:15px; text-align:center; color:var(--text-muted);">No banned users found.</td></tr>';
            return;
        }

        tbody.innerHTML = list.map(u => `
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:10px;">
                    <div style="font-weight:600;">${u.full_name || 'Unknown'}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${u.email || u.id}</div>
                </td>
                <td style="padding:10px; font-size:0.85rem;">
                    ${new Date(u.updated_at).toLocaleDateString()}
                </td>
                <td style="padding:10px;">
                    <button onclick="unbanUser('${u.id}')" class="btn" style="padding:4px 8px; font-size:0.8rem; border-color:#238636; color:#238636;">
                        Unban
                    </button>
                </td>
            </tr>
        `).join('');
    }

    window.filterBanList = () => {
        const q = document.getElementById('ban-search').value.toLowerCase();
        const filtered = bannedUsersCache.filter(u => 
            (u.full_name && u.full_name.toLowerCase().includes(q)) || 
            (u.email && u.email.toLowerCase().includes(q))
        );
        renderBanList(filtered);
    };

    window.switchTab = function(tabName) {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    };
</script>
